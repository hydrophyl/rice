{% extends 'base.html' %} {% block content %}
    <a
  onclick="goBack()"
  id="back-btn"
  class="cursor-pointer fixed top-10 left-10 p-2 rounded-full bg-gray-200 flex justify-center align-center"
  ><svg
    xmlns="http://www.w3.org/2000/svg"
    fill="none"
    viewBox="0 0 24 24"
    stroke-width="1.5"
    stroke="currentColor"
    class="w-10 h-10"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3"
    />
  </svg>
</a>
<img
  src="{{ url_for('static', filename='images/logo_beckerath.png') }}"
  class="w-32 fixed right-10 top-10"
/>
<div class="absolute z-20 right-20 inset-y-1/3">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="cursor-pointer text-slate-700 w-12 h-12" onclick="select_up()">
    <path stroke-linecap="round" stroke-linejoin="round" d="M15 11.25l-3-3m0 0l-3 3m3-3v7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="cursor-pointer text-slate-700 w-12 h-12 mt-4" onclick="select_down()">
    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="cursor-pointer text-slate-700 w-10 h-10 ml-1 mt-5 p-1 rounded-full border-md border-slate-700" onclick="select_top()"">
    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l7.5-7.5 7.5 7.5m-15 6l7.5-7.5 7.5 7.5" />
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="cursor-pointer text-slate-700 w-10 h-10 ml-1 mt-5 p-1 rounded-full border-md border-slate-700" onclick="select_bot()"">
    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 5.25l-7.5 7.5-7.5-7.5m15 6l-7.5 7.5-7.5-7.5" />
  </svg>
</div>
<div class="h-screen flex flex-col justify-center items-center">
  <h2 class="text-xxl mb-3 text-center">Wiedergabe</h2>
  <div
    class="px-2 grid grid-cols-12 w-3/4 mx-auto items-center text-neutral-900 font-bold text-lg h-12 w-12"
  >
    <div class="col-span-1">#</div>
    <div class="col-span-8">Titel</div>
    <div class="col-span-3">Dauer</div>
  </div>
  <div id="songs" class="w-3/4 h-36 overflow-scroll mx-auto items-center flex flex-col border-2 border-slate-50">
    {% for song in songs %} {% if loop.index % 2 == 0 %} {% set bg_color =
    '#f4f4f5' %} {% else %} {% set bg_color = '#fff' %} {% endif %}
    <button 
      class="focused-a w-full"
      onclick="select_song('{{song.id}}', '{{song.title}}', '{{song.length}}', '{{song.default_speed}}', '{{song.default_transposition}}')" >
      <div class="px-2 h-12 grid grid-cols-12 items-center w-full">
        <span class="col-span-1 text-left"> {{song.id}} </span>
        <span class="col-span-8 text-left"> {{ song.title }} </span>
        <span class="col-span-3 text-left">
          {{ '%02d' % (song.length|int/60) }}:{{ '%02d' % (song.length|int % 60)
          }}
        </span>
      </div>
    </button>
    {% endfor %}
  </div>
  <div class="grid grid-cols-12 w-3/4 mx-auto items-center mt-2">
    <p class="text-lg px-3 col-span-2">Geschwindigkeit</p>
    <div class="col-span-5">
      <div class="grid grid-cols-3 items-center">
        <a onclick="speedDown()" class="grid justify-items-end">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-8 h-8 rounded-full"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.75 19.5L8.25 12l7.5-7.5"
            />
          </svg>
        </a>

        <p class="text-xxl w-full text-center" id="speed-display">
          100%
        </p>
        <a onclick="speedUp()" class="grid justify-items-start">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-8 h-8 rounded-full"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M8.25 4.5l7.5 7.5-7.5 7.5"
            />
          </svg>
        </a>
      </div>
    </div>
    <div class="col-span-1"></div>
    <p class="ml-1 pl-3 col-span-4 flex">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-6 h-6"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"
        /></svg
      >Tippen ±0.01 (x0.8 - x1.2 Geschwindigkeit)
    </p>
  </div>
  <div class="grid grid-cols-12 w-3/4 mx-auto items-center mt-2">
    <p class="text-lg px-3 col-span-2">Transponieren</p>
    <div class="col-span-5">
      <div class="grid grid-cols-3 items-center">
        <a onclick="transposeDown()" class="grid justify-items-end">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-8 h-8 rounded-full"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.75 19.5L8.25 12l7.5-7.5"
            />
          </svg>
        </a>
        
        <p class="text-xxl w-full text-center" id="transpose-display">
          0.0
        </p>
        <a onclick="transposeUp()" class="grid justify-items-start">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-8 h-8 rounded-full"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M8.25 4.5l7.5 7.5-7.5 7.5"
            />
          </svg>
        </a>
      </div>
    </div>
    <div class="col-span-1"></div>
    <p class="ml-1 pl-3 col-span-4 flex">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-6 h-6"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"
        /></svg
      >Tippen ± Halbton (-3 +3 Tonhöhe)
    </p>
  </div>
  <div class="grid grid-cols-12 w-3/4 mx-auto items-center mt-2">
    <p class="text-lg px-3 col-span-2">Zeit</p>
    <div class="col-span-5 border-2 border-slate-50 h-3 w-full relative" id="timeline">
      <div
        id="percentage"
        class="absolute top-0 left-0 bg-green-300 h-2"
        style="width: 0"
      ></div>
    </div>
    <p class="text-xxl col-span-1 flex items-center justify-center">
      <!-- <span id="play-time">00:00</span> -->
      <span id="total-time">00:00</span>
    </p>
    <p class="ml-1 pl-3 col-span-4 flex">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-6 h-6"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"
        /></svg
      >Tatsächlicher Spieldauer in Minute:Sekunde
    </p>
  </div>
  <div class="grid w-3/4 mx-auto mt-5">
    <div class="flex justify-self-center relative">
      <p
        class="text-green-600 absolute -bottom-8 -left-0 text-xl w-max"
        id="play-status"
      ></p>
      <button
        class="flex justify-center items-center h-16 w-16 rounded-full bg-green-400 mr-10 pl-1 text-white"
        id="play-button"
        onclick="play()"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-10 h-10"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z"
          />
        </svg>
      </button>
      <button
        class="flex justify-center items-center h-16 w-16 rounded-full bg-slate-500 mr-10 text-white"
        id="pause-button"
        onclick="pause()"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-10 h-10"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15.75 5.25v13.5m-7.5-13.5v13.5"
          />
        </svg>
      </button>
      <button
        class="stop flex justify-center items-center h-16 w-16 rounded-full bg-slate-700 text-white"
        id="stop-button"
        onclick="stop()"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1"
          stroke="currentColor"
          class="w-13 h-13"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z"
          />
        </svg>
      </button>
    </div>
  </div>
</div>
<script>
  window.onload = function () {
    // The first song in list has the first button tag in page
    var first_song_in_list = document.getElementsByTagName("button")[0];
    first_song_in_list.click();
    first_song_in_list.focus();
    document.getElementById("back-btn").style.pointerEvents = "auto";
  };
</script>
<script>
  function goBack() {
    window.location.href = "{{url_for('main.menu')}}";
  }
</script>
<script>
  function select_song(
    song_id,
    song_title,
    song_length,
    song_speed,
    song_transposition
  ) {
    sessionStorage.setItem("song_id", song_id);
    sessionStorage.setItem("song_title", song_title);
    sessionStorage.setItem("song_length", song_length);
    sessionStorage.setItem("song_speed", song_speed);
    document.getElementById("speed-display").innerHTML =
      parseFloat(song_speed * 100)
        .toFixed(0)
        .toString() + "%";
    sessionStorage.setItem("song_transposition", song_transposition);
    document.getElementById("transpose-display").innerHTML = song_transposition;
    document.getElementById("play-status").textContent =
      "Drücken Sie ▷, um '" + song_title + "' abzuspielen";
    socket.emit("update_playback_speed", {
      value: parseFloat(song_speed).toFixed(2),
    });
    update_total_time();
  }
</script>
<script>
  function play() {
    var song_id = sessionStorage.getItem("song_id");
    document.getElementById("back-btn").style.pointerEvents = "none";
  }
  function stop() {
    document.getElementById("back-btn").style.pointerEvents = "auto";
    socket.emit("update_isPlaying", { value: false });
  }
</script>
<script>
  $(document).ready(function () {
    $("#play-button").click(function () {
      var id = sessionStorage.getItem("song_id");
      $.get("/song/playrecord", { song_id: id }, function (data) {
        // console.log(data);
      });
    });
  });
</script>
<script>
  var socket = io.connect("http://" + document.domain + ":" + location.port);
  function speedUp() {
    song_speed = sessionStorage.getItem("song_speed");
    if (song_speed < 1.5) {
      upper_speed = song_speed / 1.0 + 0.01;
      display_speed = parseFloat(upper_speed * 100)
        .toFixed(0)
        .toString();
      document.getElementById("speed-display").textContent =
        display_speed + "%";
      sessionStorage.setItem("song_speed", upper_speed);
      update_total_time();
      socket.emit("update_playback_speed", { value: upper_speed.toFixed(2) });
    }
  }
  function speedDown() {
    song_speed = sessionStorage.getItem("song_speed");
    if (song_speed > 0.6) {
      lower_speed = song_speed / 1.0 - 0.01;
      display_speed = parseFloat(lower_speed * 100)
        .toFixed(0)
        .toString();
      document.getElementById("speed-display").textContent =
        display_speed + "%";
      sessionStorage.setItem("song_speed", lower_speed);
      update_total_time();
      socket.emit("update_playback_speed", { value: lower_speed.toFixed(2) });
    }
  }

  socket.on("updatePercentage", function (data) {
    function frame(next_percentage) {
      document.getElementById("percentage").style.width = next_percentage + "%";
    }
    setTimeout(function () {
      frame(data.value);
    }, 100);
  });

  socket.on("updatePlaystatus", function (data) {
    song_title = sessionStorage.getItem("song_title");
    song_id = sessionStorage.getItem("song_id");
    if (data.value == "song play") {
      document.getElementById("play-status").textContent =
        song_title + " wird gerade gespielt";
    } else if (data.value == "song stop") {
      document.getElementById("play-status").textContent = "";
      select_down()
      document.getElementById("back-btn").style.pointerEvents = "auto";
    }
  });
</script>
<script>
  function update_total_time() {
    song_length = sessionStorage.getItem("song_length");
    song_speed = sessionStorage.getItem("song_speed");
    minute = Math.floor(song_length / song_speed / 60);
    minute = minute.toString().padStart(2, "0");
    second = Math.floor((song_length / song_speed) % 60);
    second = second.toString().padStart(2, "0");
    document.getElementById("total-time").innerHTML = minute + ":" + second;
  }
</script>
<script>
  function transposeUp() {
    var socket = io.connect("http://" + document.domain + ":" + location.port);
    song_transposition = sessionStorage.getItem("song_transposition");
    upper_transposition = song_transposition / 1.0 + 1;
    if (upper_transposition >= 0) {
      document.getElementById("transpose-display").textContent =
        "+" + upper_transposition.toFixed(1);
    } else {
      document.getElementById("transpose-display").textContent =
        upper_transposition.toFixed(1);
    }
    sessionStorage.setItem("song_transposition", upper_transposition.toFixed(1))
  }
  function transposeDown() {
    var socket = io.connect("http://" + document.domain + ":" + location.port);
    song_transposition = sessionStorage.getItem("song_transposition");
    lower_transposition = song_transposition / 1.0 - 1;
    if (lower_transposition >= 0) {
      document.getElementById("transpose-display").textContent =
        "+" + lower_transposition.toFixed(1);
    } else {
      document.getElementById("transpose-display").textContent =
        lower_transposition.toFixed(1);
    }
    sessionStorage.setItem("song_transposition", lower_transposition.toFixed(1))
  }
</script>
<script>
  function select_top() {
    song_id = sessionStorage.getItem("song_id");
    buttons = document.querySelectorAll(".focused-a");
    [...buttons].some((e) => {
      if (parseInt(e.firstElementChild.firstElementChild.innerHTML) < parseInt(song_id)) {
        e.scrollIntoView({ behavior: "smooth", block: "nearest" });
        e.click();
        e.focus();
        return "first song";
      }
    });
  }
  function select_up() {
    song_id = sessionStorage.getItem("song_id");
    buttons = document.querySelectorAll(".focused-a");
    [...buttons].some((e, index) => {
      if (parseInt(e.firstElementChild.firstElementChild.innerHTML) == parseInt(song_id)) {
        prev_index = index - 1
      }
    });
    [...buttons].some((e, index) => {
      if (index == prev_index) {
        e.scrollIntoView({ behavior: "smooth", block: "nearest" });
        e.click();
        e.focus();
        return "previous song";
      }
    });
  }
  function select_down() {
    song_id = sessionStorage.getItem("song_id");
    buttons = document.querySelectorAll(".focused-a");
    [...buttons].some((e) => {
      if (parseInt(e.firstElementChild.firstElementChild.innerHTML) > parseInt(song_id)) {
        e.scrollIntoView({ behavior: "smooth", block: "nearest" });
        e.click();
        e.focus();
        return "next song";
      }
    });
  }
  function select_bot() {
    song_id = sessionStorage.getItem("song_id");
    buttons = document.querySelectorAll(".focused-a");
    e = buttons[buttons.length - 1];
    e.scrollIntoView({ behavior: "smooth", block: "nearest" });
    e.click();
    e.focus();
  }
</script>
{% endblock %}
